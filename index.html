<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>エディター - Story Builder</title>

    <!-- External Libraries (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/stats.css">
    <link rel="stylesheet" href="css/editor.css">
</head>

<body>
    <!-- View: Login -->
    <div id="login-screen" class="view-container">
        <div class="login-box">
            <h1 class="retro-title">エディター</h1>
            <p style="margin-bottom:30px; color:#aaa;">執筆に特化したストーリー構築ツール</p>
            <button id="google-login-btn" class="btn-retro large blue">Googleでログイン</button>
        </div>
    </div>

    <!-- Main Application Shell -->
    <div id="main-app" style="display: none;">

        <!-- View: Dashboard (TOP) -->
        <div id="top-view" class="view-content view-container">
            <div class="container-narrow">
                <h1 class="retro-title">エディター</h1>

                <div class="dashboard-top">
                    <!-- Stats Section (Writing Diary Summary) -->
                    <div class="stats-card click-card" onclick="switchView('stats-view')">
                        <h3>執筆日記</h3>
                        <div class="stats-row">
                            <span>今日の文字数</span>
                            <span class="bright-green-bold"><span id="stat-today-chars">0</span> <span
                                    class="stats-unit">字</span></span>
                        </div>
                        <div class="stats-row" style="margin-top:10px;">
                            <span>過去7日間の合計</span>
                            <span class="bright-green-bold"><span id="stat-weekly-chars">0</span> <span
                                    class="stats-unit">字</span></span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-stack">
                        <button class="btn-retro large back" onclick="showWorkSetup()">＋作品作成</button>
                        <button class="btn-retro large back" onclick="switchView('memo-view')">共通メモ</button>
                    </div>
                </div>

                <!-- Sort & Filter Bar -->
                <div class="filter-bar">
                    <select id="filter-status" class="select-retro">
                        <option value="all">すべて</option>
                        <option value="in-progress">制作中</option>
                        <option value="completed">制作完了</option>
                        <option value="suspended">制作中断</option>
                    </select>
                    <select id="sort-order" class="select-retro">
                        <option value="updatedAt">更新順</option>
                        <option value="createdAt">作成日</option>
                    </select>
                </div>

                <!-- Work List -->
                <div id="work-list" class="list-container">
                    <!-- Loaded via js modules -->
                </div>
            </div>
        </div>

        <!-- View: Work Setup (Information Form) -->
        <div id="setup-view" class="view-content view-container">
            <div class="form-panel">
                <div id="setup-view-header" style="position:relative; margin-bottom:20px;">
                    <button id="work-f-back" class="btn-retro small back" style="position:absolute; left:0; top:0;"
                        onclick="switchView('top-view')">戻る</button>
                    <h2 id="setup-title" class="retro-subtitle" style="text-align:center; margin:0;">作品情報の入力</h2>
                </div>

                <div class="form-group full" style="margin-bottom:16px;">
                    <label>タイトル</label>
                    <input type="text" id="work-f-title" placeholder="作品のタイトルを入力">
                </div>
                <div class="form-group full" style="margin-bottom:16px;">
                    <div style="display:flex; align-items:baseline; gap:10px;">
                        <label>キャッチコピー</label>
                        <span id="catchphrase-count" style="font-size:0.8rem; color:#888;">残35字</span>
                    </div>
                    <input type="text" id="work-f-catchphrase" maxlength="35">
                </div>
                <div class="form-group full" style="margin-bottom:16px;">
                    <label>あらすじ</label>
                    <textarea id="work-f-summary" rows="4"></textarea>
                </div>

                <!-- Dynamic Rows (Reordered by JS) -->
                <div id="setup-row-1" class="form-row-multi">
                    <!-- Placeholder for Length/Type or Type/Status -->
                </div>

                <div id="setup-row-2" class="form-row-multi">
                    <!-- Placeholder for Status/Rating or Rating -->
                </div>

                <!-- AI - Always Full Width -->
                <div class="form-group full" style="margin-top:8px;">
                    <label>AI利用</label>
                    <div class="choice-group ai-choice-group">
                        <label><input type="radio" name="work-ai" value="none" checked> なし</label>
                        <label><input type="radio" name="work-ai" value="assist"> 補助利用</label>
                        <label><input type="radio" name="work-ai" value="partial"> 一部利用（50％以下）</label>
                        <label><input type="radio" name="work-ai" value="main"> 本文利用（50％以上）</label>
                    </div>
                </div>

                <!-- Hidden source elements for JS to move them -->
                <div id="form-elements-source" style="display:none;">
                    <div id="el-f-length" class="form-group">
                        <label>作品の長さ</label>
                        <div class="choice-group">
                            <label><input type="radio" name="work-length" value="long" checked> 長編</label>
                            <label><input type="radio" name="work-length" value="short"> 短編</label>
                        </div>
                    </div>
                    <div id="el-f-status" class="form-group">
                        <label>制作ステータス</label>
                        <div class="choice-group">
                            <label><input type="radio" name="work-status" value="in-progress" checked> 制作中</label>
                            <label><input type="radio" name="work-status" value="completed"> 完了</label>
                            <label><input type="radio" name="work-status" value="suspended"> 中断</label>
                        </div>
                    </div>
                    <div id="el-f-type" class="form-group">
                        <label>作品種別</label>
                        <div class="choice-group">
                            <label><input type="radio" name="work-type" value="original" checked> オリジナル</label>
                            <label><input type="radio" name="work-type" value="derivative"> 二次創作</label>
                        </div>
                    </div>
                    <div id="el-f-rating" class="form-group">
                        <label>レーティング</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="rating" value="sexual"> 性描写</label>
                            <label><input type="checkbox" name="rating" value="violent"> 暴力</label>
                            <label><input type="checkbox" name="rating" value="cruel"> 残酷</label>
                        </div>
                    </div>
                </div>

                <div id="setup-actions" style="display:flex; gap:16px; margin-top:24px;">
                    <button id="work-f-delete" class="btn-retro delete" style="display:none;">削除</button>
                    <button id="work-f-submit" class="btn-retro save" style="flex:1;"
                        onclick="handleWorkInfoSubmit()">保存して開始</button>
                </div>
            </div>
        </div>

        <!-- View: Work Info (View Mode) -->
        <div id="info-view" class="view-content view-container">
            <div class="form-panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 id="info-title" class="retro-subtitle">作品情報の閲覧</h2>
                    <button class="btn-retro edit" onclick="showWorkSetup(currentWorkId)">編集</button>
                </div>

                <div class="info-grid">
                    <div class="info-item full">
                        <label>キャッチコピー</label>
                        <p id="info-catchphrase" class="info-val"></p>
                    </div>
                    <div class="info-item full">
                        <label>あらすじ</label>
                        <p id="info-summary" class="info-val" style="white-space: pre-wrap;"></p>
                    </div>
                    <div class="info-row">
                        <div class="info-item">
                            <label>ステータス</label>
                            <p id="info-status" class="info-val"></p>
                        </div>
                        <div class="info-item">
                            <label>種別</label>
                            <p id="info-type" class="info-val"></p>
                        </div>
                        <div class="info-item">
                            <label>AI利用</label>
                            <p id="info-ai" class="info-val"></p>
                        </div>
                    </div>
                    <div class="info-item full">
                        <label>レーティング</label>
                        <p id="info-rating" class="info-val"></p>
                    </div>
                </div>

                <div style="margin-top:30px; display:flex; gap:16px;">
                    <button class="btn-retro back" style="flex:1;" onclick="switchView('top-view')">◀ TOP</button>
                    <button id="info-open-work" class="btn-retro save" style="flex:2;">この作品を書く</button>
                </div>
            </div>
        </div>

        <!-- View: Workspace (Editor) - 2-Pane Layout -->
        <div id="workspace-view" class="view-content">
            <div class="workspace-container">
                <!-- Left Pane: Chapter List & Navigation -->
                <div class="editor-sidebar">
                    <div class="sidebar-header">
                        <span class="gold">話一覧</span>
                        <button class="btn-icon save" onclick="addNewChapter()">＋追加</button>
                    </div>
                    <div id="chapter-list"></div>
                    <div class="sidebar-footer">
                        <button class="btn-retro large back" onclick="closeWorkspace()">◀ TOPに戻る</button>
                    </div>
                </div>

                <!-- Right Pane: Editor -->
                <div class="editor-main">
                    <div class="workspace-tabs-container">
                        <button id="tab-editor" class="ws-tab active"
                            onclick="switchWorkspaceTab('editor')">エディター</button>
                        <button id="tab-info" class="ws-tab" onclick="switchWorkspaceTab('info')">作品情報</button>
                    </div>

                    <div id="ws-content-editor" class="workspace-tab-content active">
                        <div class="editor-toolbar">
                            <button class="btn-icon back" onclick="toggleVerticalMode()">縦/横</button>
                            <button class="btn-icon back" onclick="insertRuby()">ルビ(R)</button>
                            <button class="btn-icon back" onclick="insertDash()">ダッシュ(D)</button>
                            <button class="btn-icon save" onclick="saveCurrentChapter()">保存</button>
                            <span id="editor-char-count">0 字</span>
                        </div>
                        <textarea id="main-editor" placeholder="物語を始めましょう..."></textarea>
                    </div>

                    <div id="ws-content-info" class="workspace-tab-content">
                        <!-- Setup Form will be moved here by JS when tab is active -->
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Statistics (Full) -->
        <div id="stats-view" class="view-content view-container">
            <div class="container-narrow">
                <div class="stats-full-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2 class="retro-subtitle">執筆統計</h2>
                        <div class="stats-tabs">
                            <button class="tab-btn active" onclick="updateFullStats('1W')">1週</button>
                            <button class="tab-btn" onclick="updateFullStats('1M')">1月</button>
                            <button class="tab-btn" onclick="updateFullStats('1Y')">1年</button>
                        </div>
                    </div>

                    <div class="stats-chart-main-container">
                        <canvas id="stats-chart-full"></canvas>
                    </div>
                </div>

                <div class="stats-summary-grid">
                    <div class="summary-item">
                        <label>今日の文字数</label>
                        <span class="bright-green-bold"><span id="summary-today">0</span> <span
                                class="stats-unit">字</span></span>
                    </div>
                    <div class="summary-item">
                        <label>過去7日間の合計</label>
                        <span class="bright-green-bold"><span id="summary-weekly">0</span> <span
                                class="stats-unit">字</span></span>
                    </div>
                    <div class="summary-item">
                        <label>直近30日間の合計</label>
                        <span class="bright-green-bold"><span id="summary-monthly">0</span> <span
                                class="stats-unit">字</span></span>
                    </div>
                    <div class="summary-item">
                        <label>総制作作品数</label>
                        <span class="bright-green-bold"><span id="summary-total-works">0</span> <span
                                class="stats-unit">作品</span></span>
                    </div>
                </div>

                <div style="margin-top:30px; text-align:center;">
                    <button class="btn-retro back" onclick="switchView('top-view')">◀ TOPに戻る</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script type="module" src="js/main.js"></script>
</body>

</html>